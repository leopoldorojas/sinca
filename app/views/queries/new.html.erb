<h1><%= t('query.new') %></h1>

<%= form_for @query, remote: false, data: { type: :json } do |f| %>
  <div class="row">
    <fieldset class="small-12 columns">
      <legend><%= t('query.dates_and_periods') %></legend>
      <div class="small-4 columns">
        <%= f.label :end_date %>
        <%= f.date_field :end_date, { value: @query.end_date } %>
      </div>

      <div class="small-6 columns">
        <%= f.label :type %>

        <%= f.radio_button :type, :all, { value: @query.type } %>
        <%= label_tag(:type_all, t('query.types.all')) %>

        <%= f.radio_button :type, :year, { value: @query.type } %>
        <%= label_tag(:type_yearly, t('query.types.yearly')) %>

        <%= f.radio_button :type, :quarter, { value: @query.type } %>
        <%= label_tag(:type_quarterly, t('query.types.quarterly')) %>

        <%= f.radio_button :type, :month, { value: @query.type } %>
        <%= label_tag(:type_monthly, t('query.types.monthly')) %>
      </div>

      <div class="small-2 columns">
      </div>
    </fieldset>

    <% unless current_user.role == 'company_user' %>
      <fieldset class="small-12 columns">
        <legend><%= t('query.narrow_your_search_header') %></legend>

        <div class="small-4 columns">
          <%= f.label :location %>
          <%= f.collection_select :location, Location.all, :id, :name, prompt: t('query.prompt_location') %>
        </div>

        <div class="small-6 columns">
          <%= f.label :companies %>
          <%= f.text_field :companies, { value: (@query.companies if @query.companies.present? && @query.location.blank?) } %>
        </div>

        <div class="small-2 columns">
        </div>

      </fieldset>
    <% end %>
  </div>

  <div class="actions">
    <%= f.submit t('do_query'), class: "button small radius" %>
  </div>
<% end %>

<% if @query.results.present? %>
  <p id='result_start'><b>Los resultados de tu consulta son:</b></p>
  <% if @query.type == "year" || @query.type == "quarter"%>
    <%= content_tag "div", id: "bar_graphs", data: { results: @query.results, inames: "#{Rails.application.config.individual_indicators.to_json}" } do %>
    <% end %>
  <% elsif @query.type == "month" %>
    <%= content_tag "div", id: "line_graphs", data: { results: @query.results, inames: "#{Rails.application.config.individual_indicators.to_json}" } do %>
    <% end %>
  <% end %>
  <% @query.results.each do |indicator| %>
    <div id='text_<%= "#{indicator[:indicator]}" %>', class="graph_detail">
      <p><b>Para el Indicador <%= "#{Rails.application.config.individual_indicators[indicator[:indicator]]}" %>, se tienen los siguientes resultados</b><br>
      <% indicator[:results].each do |r| %>
        <%= "- El promedio en la fecha #{r[:date].strftime('%Y-%m-%d')} es #{as_decimal(r[:result].average) || 'incalculable'}" %>
        <% unless Rails.application.config.indicator_rules.keys.include?(indicator[:indicator]) %>
          <%= " y la suma es #{as_decimal(r[:result].sum)}" %>
        <% end %>
        <%= " con #{r[:result].count} registros contabilizados" %><br>
      <% end %>
      </p><hr/>
    </div>
  <% end %>
<% else %>
  <p id='result_start'></p>
  <% @all_indicators.each_key do |i| %>
    <p id='<%= "result_#{i}" %>'></p>
  <% end %>
  <p id='result_error'></P>
<% end %>

<%= link_to t('back'), indicators_path %>
