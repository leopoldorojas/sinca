<h1><%= t('query.new') %></h1>

<%= form_for @query, remote: false, data: { type: :json } do |f| %>
  <div class="row">
    <div class="small-12 columns">
      <div class="small-4 columns">
        <%= f.label :end_date %>
        <%= f.date_field :end_date, { value: @query.end_date } %>
      </div>

      <div class="small-6 columns">
        <%= f.label :type %>

        <%= f.radio_button :type, :all, { value: @query.type } %>
        <%= label_tag(:type_all, t('query.types.all')) %>

        <%= f.radio_button :type, :year, { value: @query.type } %>
        <%= label_tag(:type_yearly, t('query.types.yearly')) %>

        <%= f.radio_button :type, :month, { value: @query.type } %>
        <%= label_tag(:type_monthly, t('query.types.monthly')) %>

        <%= f.radio_button :type, :week, { value: @query.type } %>
        <%= label_tag(:type_weekly, t('query.types.weekly')) %>
      </div>

      <div class="small-2 columns">
      </div>
    </div>
  </div>

  <div class="actions">
    <%= f.submit t('do_query'), class: "button small radius" %>
  </div>
<% end %>

<% if @query.has_results? %>
  <p id='result_start'><b>Los resultados de tu consulta son:</b></p>
  <% @query.result_matrix.each_key do |date| %>
    <p><b>Para la fecha de <%= "#{date}" %>, se tienen los siguientes resultados</b><p>
    <% @query.result_matrix[date].each do |indicator, r| %>
      <p>
        <%= "- El promedio de #{Rails.application.config.individual_indicators[indicator]} es #{as_decimal(r.average) || 'incalculable'} y la suma es #{as_decimal(r.sum)} con #{r.count} registros contabilizados" %>
      </p>
    <% end %>
    <hr/>
  <% end %>
<% else %>
  <p id='result_start'></p>
  <% @all_indicators.each_key do |i| %>
    <p id='<%= "result_#{i}" %>'></p>
  <% end %>
  <p id='result_error'></P>
<% end %>

<%= link_to t('back'), indicators_path %>
